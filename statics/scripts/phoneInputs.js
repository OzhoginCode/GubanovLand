const i18n = {
  locale: 'ru',
  countries: {
    au: 'Австралия',
    at: 'Австрия',
    az: 'Азербайджан',
    ax: 'Аландские острова',
    al: 'Албания',
    dz: 'Алжир',
    vi: 'Виргинские Острова (США)',
    as: 'Американское Самоа',
    ai: 'Ангилья',
    ao: 'Ангола',
    ad: 'Андорра',
    aq: 'Антарктида',
    ag: 'Антигуа и Барбуда',
    ar: 'Аргентина',
    am: 'Армения',
    aw: 'Аруба',
    af: 'Афганистан',
    bs: 'Багамы',
    bd: 'Бангладеш',
    bb: 'Барбадос',
    bh: 'Бахрейн',
    bz: 'Белиз',
    by: 'Беларусь',
    be: 'Бельгия',
    bj: 'Бенин',
    bm: 'Бермуды',
    bg: 'Болгария',
    bo: 'Боливия',
    bq: 'Бонэйр, Синт-Эстатиус и Саба',
    ba: 'Босния и Герцеговина',
    bw: 'Ботсвана',
    br: 'Бразилия',
    io: 'Британская территория в Индийском океане',
    vg: 'Виргинские Острова (Великобритания)',
    bn: 'Бруней',
    bf: 'Буркина-Фасо',
    bi: 'Бурунди',
    bt: 'Бутан',
    vu: 'Вануату',
    va: 'Ватикан',
    gb: 'Великобритания',
    hu: 'Венгрия',
    ve: 'Венесуэла',
    um: 'Внешние малые острова (США)',
    tl: 'Восточный Тимор',
    vn: 'Вьетнам',
    ga: 'Габон',
    ht: 'Гаити',
    gy: 'Гайана',
    gm: 'Гамбия',
    gh: 'Гана',
    gp: 'Гваделупа',
    gt: 'Гватемала',
    gf: 'Гвиана',
    gn: 'Гвинея',
    gw: 'Гвинея-Бисау',
    de: 'Германия',
    gg: 'Гернси',
    gi: 'Гибралтар',
    hn: 'Гондурас',
    hk: 'Гонконг',
    gd: 'Гренада',
    gl: 'Гренландия',
    gr: 'Греция',
    ge: 'Грузия',
    gu: 'Гуам',
    dk: 'Дания',
    je: 'Джерси',
    dj: 'Джибути',
    dm: 'Доминика',
    do: 'Доминиканская Республика',
    cd: 'Демократическая Республика Конго',
    eg: 'Египет',
    zm: 'Замбия',
    eh: 'САДР',
    zw: 'Зимбабве',
    il: 'Израиль',
    in: 'Индия',
    id: 'Индонезия',
    jo: 'Иордания',
    iq: 'Ирак',
    ir: 'Иран',
    ie: 'Ирландия',
    is: 'Исландия',
    es: 'Испания',
    it: 'Италия',
    ye: 'Йемен',
    cv: 'Кабо-Верде',
    kz: 'Казахстан',
    ky: 'Острова Кайман',
    kh: 'Камбоджа',
    cm: 'Камерун',
    ca: 'Канада',
    qa: 'Катар',
    ke: 'Кения',
    cy: 'Кипр',
    kg: 'Кыргызстан',
    ki: 'Кирибати',
    tw: 'Тайвань',
    kp: 'КНДР (Корейская Народно-Демократическая Республика)',
    cn: 'КНР (Китайская Народная Республика)',
    cc: 'Кокосовые острова',
    co: 'Колумбия',
    km: 'Коморы',
    cr: 'Коста-Рика',
    ci: 'Кот-д’Ивуар',
    cu: 'Куба',
    kw: 'Кувейт',
    cw: 'Кюрасао',
    la: 'Лаос',
    lv: 'Латвия',
    ls: 'Лесото',
    lr: 'Либерия',
    lb: 'Ливан',
    ly: 'Ливия',
    lt: 'Литва',
    li: 'Лихтенштейн',
    lu: 'Люксембург',
    mu: 'Маврикий',
    mr: 'Мавритания',
    mg: 'Мадагаскар',
    yt: 'Майотта',
    mo: 'Макао',
    mw: 'Малави',
    my: 'Малайзия',
    ml: 'Мали',
    mv: 'Мальдивы',
    mt: 'Мальта',
    ma: 'Марокко',
    mq: 'Мартиника',
    mh: 'Маршалловы Острова',
    mx: 'Мексика',
    fm: 'Микронезия',
    mz: 'Мозамбик',
    md: 'Молдавия',
    mc: 'Монако',
    mn: 'Монголия',
    ms: 'Монтсеррат',
    mm: 'Мьянма',
    na: 'Намибия',
    nr: 'Науру',
    np: 'Непал',
    ne: 'Нигер',
    ng: 'Нигерия',
    nl: 'Нидерланды',
    ni: 'Никарагуа',
    nu: 'Ниуэ',
    nz: 'Новая Зеландия',
    nc: 'Новая Каледония',
    no: 'Норвегия',
    ae: 'ОАЭ',
    om: 'Оман',
    bv: 'Остров Буве',
    im: 'Остров Мэн',
    ck: 'Острова Кука',
    nf: 'Остров Норфолк',
    cx: 'Остров Рождества',
    pn: 'Острова Питкэрн',
    sh: 'Острова Святой Елены, Вознесения и Тристан-да-Кунья',
    pk: 'Пакистан',
    pw: 'Палау',
    ps: 'Государство Палестина',
    pa: 'Панама',
    pg: 'Папуа — Новая Гвинея',
    py: 'Парагвай',
    pe: 'Перу',
    pl: 'Польша',
    pt: 'Португалия',
    pr: 'Пуэрто-Рико',
    cg: 'Республика Конго',
    kr: 'Республика Корея',
    re: 'Реюньон',
    ru: 'Россия',
    rw: 'Руанда',
    ro: 'Румыния',
    sv: 'Сальвадор',
    ws: 'Самоа',
    sm: 'Сан-Марино',
    st: 'Сан-Томе и Принсипи',
    sa: 'Саудовская Аравия',
    sz: 'Эсватини',
    mk: 'Северная Македония',
    mp: 'Северные Марианские Острова',
    sc: 'Сейшельские Острова',
    bl: 'Сен-Бартелеми',
    mf: 'Сен-Мартен',
    pm: 'Сен-Пьер и Микелон',
    sn: 'Сенегал',
    vc: 'Сент-Винсент и Гренадины',
    kn: 'Сент-Китс и Невис',
    lc: 'Сент-Люсия',
    rs: 'Сербия',
    sg: 'Сингапур',
    sx: 'Синт-Мартен',
    sy: 'Сирия',
    sk: 'Словакия',
    si: 'Словения',
    sb: 'Соломоновы Острова',
    so: 'Сомали',
    sd: 'Судан',
    sr: 'Суринам',
    us: 'США',
    sl: 'Сьерра-Леоне',
    tj: 'Таджикистан',
    th: 'Таиланд',
    tz: 'Танзания',
    tc: 'Теркс и Кайкос',
    tg: 'Того',
    tk: 'Токелау',
    to: 'Тонга',
    tt: 'Тринидад и Тобаго',
    tv: 'Тувалу',
    tn: 'Тунис',
    tm: 'Туркмения',
    tr: 'Турция',
    ug: 'Уганда',
    uz: 'Узбекистан',
    ua: 'Украина',
    wf: 'Уоллис и Футуна',
    uy: 'Уругвай',
    fo: 'Фареры',
    fj: 'Фиджи',
    ph: 'Филиппины',
    fi: 'Финляндия',
    fk: 'Фолклендские острова',
    fr: 'Франция',
    pf: 'Французская Полинезия',
    tf: 'Французские Южные и Антарктические Территории',
    hm: 'Херд и Макдональд',
    hr: 'Хорватия',
    cf: 'ЦАР',
    td: 'Чад',
    me: 'Черногория',
    cz: 'Чехия',
    cl: 'Чили',
    ch: 'Швейцария',
    se: 'Швеция',
    sj: 'Шпицберген и Ян-Майен',
    lk: 'Шри-Ланка',
    ec: 'Эквадор',
    gq: 'Экваториальная Гвинея',
    er: 'Эритрея',
    ee: 'Эстония',
    et: 'Эфиопия',
    za: 'ЮАР',
    gs: 'Южная Георгия и Южные Сандвичевы Острова',
    ss: 'Южный Судан',
    jm: 'Ямайка',
    jp: 'Япония',
    xk: 'Косово',
    ac: 'Остров Вознесения',
  },
};

const itiConfig = {
  utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@20.3.0/build/js/utils.js',
  showSelectedDialCode: true,
  nationalMode: false,
  autoPlaceholder: 'agressive',
  containerClass: 'phonenumber-input-container',
  preferredCountries: ['ru', 'am', 'by', 'kz', 'kg'],
  countrySearch: false,
  initialCountry: 'ru',
  i18n: i18n.countries,
};

const formsState = {
  state: 'filling',
  forms: {
    mainForm: {
      state: 'invalid',
      data: {
        name: '',
        phone: '',
      },
      isValid: {
        name: false,
        phone: false,
        policy: true,
      },
      touched: {
        name: false,
        phone: false,
      },
    },
    modalForm: {
      state: 'invalid',
      data: {
        name: '',
        phone: '',
      },
      isValid: {
        name: false,
        phone: false,
        policy: true,
      },
      touched: {
        name: false,
        phone: false,
      },
    },
  },
};

const elements = {
  forms: {
    mainForm: document.querySelector('[data-form="mainForm"]'),
    modalForm: document.querySelector('[data-form="modalForm"]'),
  },
  inputs: {
    name: {
      mainForm: document.querySelector('.section-communication-form .form-name'),
      modalForm: document.querySelector('.modal-form .form-name'),
    },
    phone: {
      mainForm: document.querySelector('.section-communication-form .form-phone'),
      modalForm: document.querySelector('.modal-form .form-phone'),
    },
    policy: {
      mainForm: document.querySelector('.section-communication-form-agreement-input'),
      modalForm: document.querySelector('.modal-form-agreement-input'),
    },
  },
  buttons: {
    mainForm: document.querySelector('.section-communication-form-button'),
    modalForm: document.querySelector('.modal-form-button'),
  },
};

const phoneInputs = Object.values(elements.inputs.phone);
const nameInputs = Object.values(elements.inputs.name);
const policyCheckboxes = Object.values(elements.inputs.policy);
const applyButtons = Object.values(elements.buttons);
const message = elements.forms.mainForm.querySelector('#message');

const disableForms = () => {
  const elems = [...phoneInputs, ...nameInputs, ...applyButtons, message];

  elems.forEach((el) => el.setAttribute('disabled', true));
};

const enableForms = () => {
  const elems = [...phoneInputs, ...nameInputs, message];

  elems.forEach((el) => el.removeAttribute('disabled'));
};

const clearForms = () => {
  const form1 = elements.forms.mainForm;
  const form2 = elements.forms.modalForm;
  form1.reset();
  form2.reset();
};

const render = () => {
  switch (formsState.state) {
    case 'filling':
      Object.entries(formsState.forms).forEach(([form, state]) => {
        Object.entries(state.isValid).forEach(([field, isValid]) => {
          if (field === 'policy') return;

          const touched = formsState.forms[form].touched[field];
          if (!touched) return;

          const input = elements.inputs[field][form];
          const fieldset = input.closest('fieldset');
          const error = fieldset.querySelector('.form-input-error');

          error.classList.remove('display-none');
          fieldset.classList.add('fieldset-error');

          if (isValid) {
            error.classList.add('display-none');
            fieldset.classList.remove('fieldset-error');
          }
        });

        enableForms();

        const applyButton = elements.forms[form].querySelector('button');
        applyButton.setAttribute('disabled', true);
        if (state.state === 'valid') {
          applyButton.removeAttribute('disabled');
        }
      });
      break;
    case 'sending':
      disableForms();
      break;
    case 'sent':
      clearForms();
      break;
    default:
      throw new Error(`Unexpected formsState: "${formsState.state}"`);
  }
};

const handlePhoneInput = (input) => {
  const iti = window.intlTelInput(input, itiConfig);
  const formEl = input.closest('form');
  const { form } = formEl.dataset;
  input.addEventListener('input', () => {
    const isValid = iti.isValidNumber();
    const phone = iti.getNumber();
    formsState.forms[form].isValid.phone = isValid;
    formsState.forms[form].touched.phone = true;
    formsState.forms[form].data.phone = phone;
    const isFormValid = Object.entries(formsState.forms[form].isValid).every(([, value]) => value);
    formsState.forms[form].state = isFormValid ? 'valid' : 'invalid';
    render();
  });
};

const handleNameinput = (input) => {
  const formEl = input.closest('form');
  const { form } = formEl.dataset;
  input.addEventListener('input', () => {
    const name = input.value;
    const isValid = !!name.length;
    formsState.forms[form].isValid.name = isValid;
    formsState.forms[form].touched.name = true;
    formsState.forms[form].data.name = name;
    const isFormValid = Object.entries(formsState.forms[form].isValid).every(([, value]) => value);
    formsState.forms[form].state = isFormValid ? 'valid' : 'invalid';
    render();
  });
};

const handlePolicy = (input) => {
  const formEl = input.closest('form');
  const { form } = formEl.dataset;
  input.addEventListener('change', () => {
    formsState.forms[form].isValid.policy = input.checked;
    const isFormValid = Object.entries(formsState.forms[form].isValid).every(([, value]) => value);
    formsState.forms[form].state = isFormValid ? 'valid' : 'invalid';
    render();
  });
};

phoneInputs.forEach(handlePhoneInput);
nameInputs.forEach(handleNameinput);
policyCheckboxes.forEach(handlePolicy);

const routes = {
  applicationsPath: () => '/applications',
};

const apply = async (button, e) => {
  e.preventDefault();

  const form = button.closest('form');
  const formdata = new FormData(form);
  const formDataObject = Object.fromEntries(formdata.entries());

  formDataObject.message = formDataObject.message || null;
  formDataObject.formType = form.dataset.form;
  formDataObject.applicationType = form.dataset.applicationType;

  formsState.state = 'sending';
  render();

  try {
    const response = await fetch(`https://gubanovmusic.ru/api${routes.applicationsPath()}`, {
      method: 'POST',
      body: formDataObject,
    });

    if (!response.ok) {
      throw new Error();
    }

    formsState.state = 'filling';
    render();
    const event = new Event('form-sent');
    document.dispatchEvent(event);
  } catch (err) {
    formsState.state = 'filling';
    render();

    // eslint-disable-next-line no-alert
    alert('Что-то пошло не так, попробуйте перезагрузить страницу. Если перезагрузка не поможет, попробуйте позднее или свяжитесь с нами по контактам, указанным внизу страницы');
  }
};

applyButtons.forEach((btn) => btn.addEventListener('click', (e) => apply(btn, e)));
